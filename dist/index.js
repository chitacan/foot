// Generated by CoffeeScript 1.9.0
(function() {
  var app;

  app = angular.module('footApp', ['ngStorage']);

  app.config(function($httpProvider) {
    return delete $httpProvider.defaults.headers.common['X-Requested-With'];
  });

  app.controller('footCtrl', function($scope, program, player) {
    var init;
    init = function() {
      return program.fetch().then(function(res) {
        console.log(res);
        $scope.programs = res;
        return $scope.isError = false;
      })["catch"](function(e) {
        console.error(e);
        return $scope.isError = true;
      });
    };
    $scope.onClickList = function(program) {
      if (program.status === 4) {
        return player.play(program);
      }
    };
    $scope.onClickRetry = init;
    return init();
  });

  app.service('program', function($http, $q, _) {
    this.list = function() {
      var req;
      req = {
        method: 'GET',
        url: 'https://www.kimonolabs.com/api/3kplvmje',
        params: {
          apikey: 'YmPUBuAN7hpEa3LbfEsA5zAgdEs0qcuW'
        }
      };
      return $http(req);
    };
    this.info = function() {
      var req;
      req = {
        method: 'GET',
        url: 'https://www.kimonolabs.com/api/dumtajyi',
        params: {
          apikey: 'YmPUBuAN7hpEa3LbfEsA5zAgdEs0qcuW'
        }
      };
      return $http(req);
    };
    this.fetch = function() {
      return $q.all({
        list: this.list(),
        info: this.info()
      }).then(function(res) {
        var list, programs, resc;
        programs = JSON.parse(res.list.data.results.collection1[0].programs);
        list = programs.message;
        resc = res.info.data.results.resources;
        return _.map(list, function(v) {
          return _.extend(v, _.find(resc, function(r) {
            return r.url.indexOf(v.fileName) > 0;
          }));
        });
      });
    };
    return this;
  });

  app.service('player', function($rootScope, $localStorage) {
    var element, player;
    player = audiojs.createAll()[0];
    element = player.element;
    element.addEventListener('pause', (function(_this) {
      return function() {
        return _this.mark();
      };
    })(this));
    element.addEventListener('seeked', (function(_this) {
      return function() {
        return _this.mark();
      };
    })(this));
    element.addEventListener('play', function() {
      return console.log('play');
    });
    element.addEventListener('error', function() {
      return console.log('error');
    });
    this.play = function(program) {
      var position;
      position = this.lastPosition(program.radioId);
      player.id = program.radioId;
      player.load(program.url + ("#t=" + position));
      return player.play();
    };
    this.lastPosition = function(id) {
      var _ref;
      return Math.round((_ref = $localStorage[id]) != null ? _ref : 0);
    };
    this.mark = function() {
      $localStorage[player.id] = element.currentTime;
      return $rootScope.$apply();
    };
    return this;
  });

  app.factory('_', function() {
    return window._;
  });

  app.filter('trusted', function($sce) {
    return function(url) {
      return $sce.trustAsResourceUrl(url);
    };
  });

}).call(this);
